<script src="https://cdnjs.cloudflare.com/ajax/libs/js-sha256/0.9.0/sha256.min.js" integrity="sha512-szJ5FSo9hEmXXe7b5AUVtn/WnL8a5VofnFeYC2i2z03uS2LhAch7ewNLbl5flsEmTTimMN0enBZg/3sQ+YOSzQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/aes-js/3.1.2/index.min.js" integrity="sha512-LOqfKFwH2W3jeb0NzXcImFlSyoL7hjsWbZvIeKNOaZw1gFw+yKTE/QUDGLit2KWdd57qd6IgMDkppK2tkwIEhA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script>
    let paths = [];
    let server_code={server_code}
    let key=aesjs.utils.hex.toBytes(sha256(server_code+'*'+prompt('password: ','')))
    function encrypt(bytes,client_code){
        let iv=aesjs.utils.hex.toBytes(sha256(server_code+'*'+client_code)).slice(0,16)
        let cipher=new aesjs.ModeOfOperation.cbc(key,iv)
        let len=bytes.length
        let ret=new Uint8Array(bytes.length+16-(bytes.length)%16)
        for(let i=0;i<bytes.length;i++){
            ret[i]=bytes[i]
        }
        return [cipher.encrypt(ret),len]
    }
    function pack_url(url,client_code){
        if(url.split('?').length>1)
            url+='&ac=true'
        else
            url+='?ac=true'
        let obj=encrypt(aesjs.utils.utf8.toBytes(url),client_code)
        c=aesjs.utils.hex.fromBytes(obj[0])
        return `/?ciphertext=${c}&client_code=${client_code}&size=${obj[1]}`
    }
    function decrypt(bytes, client_code, size) {
        let iv = aesjs.utils.hex.toBytes(sha256(server_code + '*' + client_code)).slice(0, 16)
        let cipher = new aesjs.ModeOfOperation.cbc(key, iv)
        return cipher.decrypt(bytes).slice(0, size)
    }
    function updateDirGlobal(path) {
        let url = '/dir/' + path
        let client_code=Math.floor(Math.random() * 100000000);
        url=pack_url(url,client_code);
        fetch(url)
            .then(res => {
                return res.text();
            })
            .then(txt => {
                let temp
                try {
                    temp = JSON.parse(txt)
                    temp=decrypt(aesjs.utils.hex.toBytes(temp[0]),client_code,temp[1])
                    temp=aesjs.utils.utf8.fromBytes(temp)
                    temp=JSON.parse(temp)
                } catch (err) {
                    return alert('folder not found.')
                }
                //path
                let pathhtm = document.getElementById('path')
                pathhtm.innerHTML = ''
                paths = path.split('/')
                path = ''
                pathhtm.innerHTML += `<span onclick="updateDirGlobal('')">/</span>`
                for (let i in paths) {
                    if (paths[i] == '')
                        continue
                    path += paths[i] + '/'
                    pathhtm.innerHTML += `<span onclick="updateDirGlobal('${path}')">${paths[i]}/</span>`
                }
                //content
                files = temp.files;
                dirs = temp.dirs;
                let content = document.getElementById('content');
                content.innerHTML = '';
                for (let i in dirs) {
                    content.innerHTML += `<div><span onclick="updateDirLocal('${dirs[i]}')">${dirs[i]}/</span>    <span onclick="deleteDir('${dirs[i]}')">delete</span>    <span onclick="renameDir('${dirs[i]}')">rename</span></div>`
                }
                for (let i in files) {
                    content.innerHTML += `<div><span onclick="downloadFile('${files[i]}')">${files[i]}</span>    <span onclick="deleteFile('${files[i]}')">delete</span>    <span onclick="renameFile('${files[i]}')">rename</span></div>`
                }
            })
    }
    function updateDirLocal(click) {
        let path = ''
        for (let i in paths) {
            if (paths[i] != '')
                path += paths[i] + '/'
        }
        path += click
        updateDirGlobal(path);
    }
    function downloadFile(click) {
        let path = ''
        for (let i in paths) {
            path += paths[i] + '/'
        }
        path += click
        let url = '/file/' + path;
        let client_code=Math.floor(Math.random() * 100000000);
        url=pack_url(url,client_code);
        fetch(url)
            .then(res => {
                return res.blob();
            })
            .then(data => {
                if (data.size == 0)
                    return alert('empty file.')
                let a = document.createElement('a');
                a.href = URL.createObjectURL(data);
                a.download = click;
                document.body.appendChild(a);
                a.click();
                a.remove();
            })
    }
    function downloadZip() {
        let path = ''
        for (let i in paths) {
            path += paths[i] + '/'
        }
        let url = '/zip/' + path;
        let client_code=Math.floor(Math.random() * 100000000);
        url=pack_url(url,client_code);
        fetch(url)
            .then(res => {
                return res.blob();
            })
            .then(data => {
                if (data.size == 0)
                    return alert('empty file.')
                var a = document.createElement('a');
                a.href = URL.createObjectURL(data);
                if(paths.length==0)
                    a.download = 'root.zip';
                else
                    a.download=paths[paths.length-1]+'.zip'
                document.body.appendChild(a);
                a.click();
                a.remove();
            })
    }
    async function sendFile() {
        let path = '/file/'
        for (let i in paths) {
            path += paths[i] + '/'
        }
        let files = document.getElementById('file').files;
        let txt=''
        for (let i = 0; i < files.length; i++) {
            let client_code=Math.floor(Math.random() * 100000000);
            let url=pack_url(path + files[i].name,client_code);
            let res=await fetch(url, {
                body: files[i],
                method: 'POST'
            })
            txt+=(await res.text())+'\n';
        }
        alert(txt)
        updateDirLocal('')
    }
    function createFolder() {
        let path = '/'
        for (let i in paths) {
            if (paths[i] != '')
                path += paths[i] + '/'
        }
        path = prompt('Folder path: ', path);
        let client_code=Math.floor(Math.random() * 100000000);
        let url=pack_url('/dir' + path,client_code);
        fetch(url, {
            method: 'POST'
        }).then(res => res.text())
            .then(txt =>{
                alert(txt)
                updateDirLocal('')
            })
    }
    function deleteFile(click) {
        let path = '/file/'
        for (let i in paths) {
            path += paths[i] + '/'
        }
        path += click
        let client_code=Math.floor(Math.random() * 100000000);
        let url=pack_url(path,client_code);
        fetch(url, {
            method: 'DELETE'
        }).then(res => res.text())
            .then(txt =>{
                alert(txt)
                updateDirLocal('')
            })
    }
    function deleteDir(click) {
        let path = '/dir/'
        for (let i in paths) {
            path += paths[i] + '/'
        }
        path += click
        let client_code=Math.floor(Math.random() * 100000000);
        let url=pack_url(path,client_code);
        fetch(url, {
            method: 'DELETE'
        }).then(res => res.text())
            .then(txt =>{
                alert(txt)
                updateDirLocal('')
            })
    }
    function renameDir(click) {
        let path = '/'
        for (let i in paths) {
            if (paths[i] != '')
                path += paths[i] + '/'
        }
        path += click
        newpath = prompt('New folder name: ', path)
        let client_code=Math.floor(Math.random() * 100000000);
        let url=pack_url('/dir' + path + '?newpath=' + newpath,client_code);
        fetch(url, {
            method: 'PATCH'
        }).then(res => res.text())
            .then(txt =>{
                alert(txt)
                updateDirLocal('')
            })
    }
    function renameFile(click) {
        let path = '/'
        for (let i in paths) {
            if (paths[i] != '')
                path += paths[i] + '/'
        }
        path += click
        newpath = prompt('New file name: ', path)
        let client_code=Math.floor(Math.random() * 100000000);
        let url=pack_url('/file' + path + '?newpath=' + newpath,client_code);
        fetch(url, {
            method: 'PATCH'
        }).then(res => res.text())
            .then(txt =>{
                alert(txt)
                updateDirLocal('')
            })
    }
</script>

<body onload="updateDirGlobal('')">
    <div id="path"></div>
    <input type="file" multiple="true" onchange="sendFile()" id="file">
    <button onclick="createFolder()">Create new folder</button>
    <button onclick="downloadZip()">Download Folder (zip)</button>
    <div id="content"></div>
</body>